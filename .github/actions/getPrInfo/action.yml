name: "Get pr info"
description: "Get pr info"

inputs:
  prId:
    description: "Pr id"
    required: true
    default: '${{ github.event.pull_request.number }}'

runs:
  using: "composite"
  steps:
  - name: Get pr info
    uses: stevei5mc/Get-PR-info-action@main
    id: getPrInfo
    with:
      prId: '${{ inputs.prId }}'
  - name: Set pull request env info
    shell: bash
    run: |
      echo "targetRef=$(echo pull/${{ inputs.PR_ID }}/merge | sed 's/\//\\\//g')" >> $GITHUB_ENV
      echo "targetSha=$(echo ${{ steps.getPrInfo.outputs.headSha }} | cut -c 1-7)" >> $GITHUB_ENV
      echo "baseSha=$(echo ${{ steps.getPrInfo.outputs.baseSha }} | cut -c 1-7)" >> $GITHUB_ENV
      echo "baseUrl=$(echo ${{ steps.getPrInfo.outputs.baseRepoUrl }} | sed 's/\//\\\//g')" >> $GITHUB_ENV
      echo "baselabel=$(echo ${{ steps.getPrInfo.outputs.baseLabel }} | sed 's/\//\\\//g')" >> $GITHUB_ENV
      echo "headUrl=$(echo ${{ steps.getPrInfo.outputs.headRepoUrl }} | sed 's/\//\\\//g')" >> $GITHUB_ENV
      echo "headlabel=$(echo ${{ steps.getPrInfo.outputs.headLabel }} | sed 's/\//\\\//g')" >> $GITHUB_ENV
      echo "prUrl=$(echo ${{ steps.getPrInfo.outputs.htmlUrl }} | sed 's/\//\\\//g')" >> $GITHUB_ENV
  - name: Pull request summary
    shell: bash
    env:
      summaryTemplateFilePath: .github/template/pr-summary.md
    run: |
      sed -i 's|{1A}|${{ inputs.PR_ID }}|g; s|{1B}|${{ env.prUrl }}|g' ${{ env.summaryTemplateFilePath }}
      sed -i 's|{2}|${{ steps.getPrInfo.outputs.commits }}|g; s|{3}|${{ steps.getPrInfo.outputs.prState }}|g' ${{ env.summaryTemplateFilePath }}
      sed -i 's|{4}|${{ steps.getPrInfo.outputs.additions }}|g; s|{5}|${{ steps.getPrInfo.outputs.deletions }}|g; s|{6}|${{ steps.getPrInfo.outputs.changedFiles }}|g' ${{ env.summaryTemplateFilePath }}
      sed -i 's|{7}|${{ steps.getPrInfo.outputs.requestUser }}|g' ${{ env.summaryTemplateFilePath }}
      sed -i 's|{8A}|${{ env.headlabel }}|g; s|{8B}|${{ env.headUrl }}|g; s|{8C}|${{ env.targetSha }}|g' ${{ env.summaryTemplateFilePath }}
      sed -i 's|{9A}|${{ env.baselabel }}|g; s|{9B}|${{ env.baseUrl }}|g; s|{9C}|${{ env.baseSha }}|g' ${{ env.summaryTemplateFilePath }}
      cat ${{ env.summaryTemplateFilePath }} >> $GITHUB_STEP_SUMMARY
  - name: Pull request status check
    shell: bash
    run: |
      if [ '${{ steps.getPrInfo.outputs.prState }}' = 'closed' ]; then
        echo "prState=closed" >> $GITHUB_ENV
        echo "::error::The pull request state is closed state"
        exit 1
      elif [ '${{ steps.getPrInfo.outputs.prLockedState }}' = 'true' ]; then
        echo "prState=locked" >> $GITHUB_ENV
        echo "::error::The pull request state is locked state"
        exit 1
      elif [ '${{ steps.getPrInfo.outputs.prDraftState }}' = 'true' ]; then
        echo "prState=draft" >> $GITHUB_ENV
        echo "::error::The pull request state is draft state"
        exit 1
      else
        echo "prState=open" >> $GITHUB_ENV
      fi